apiVersion: v1
kind: Template
metadata:
  annotations:
    description: |-
          Gerrit service, with persistent storage.
          NOTE: You must have persistent volumes available in your cluster to use this template.
    iconClass: icon-jenkins
    openshift.io/display-name: EDP Gerrit (Persistent - gluster)
    tags: ci-cd
    #template.openshift.io/documentation-url: https://docs.openshift.org/latest/using_images/other_images/jenkins.html
    template.openshift.io/long-description: This template deploys a Gerrit server
      capable of managing OpenShift Pipeline builds and supporting OpenShift-based
      oauth login.
    template.openshift.io/provider-display-name: Red Hat, Inc.
    template.openshift.io/support-url: https://access.redhat.com
  name: gerrit
message: "Login to Gerrit with the you EPAM GitLab account"
objects:
- apiVersion: v1
  kind: ServiceAccount
  metadata:
    name: gerrit
{% if mr_deploy == 'false' %}
- apiVersion: v1
  kind: PersistentVolumeClaim
  metadata:
    name: gerrit-data
  spec:
    storageClassName: ${STORAGE_CLASS_NAME}
    accessModes:
    - ReadWriteOnce
    resources:
      requests:
        storage: ${GERRIT_DATA_CAPACITY}
- apiVersion: v1
  kind: PersistentVolumeClaim
  metadata:
    name: gerrit-db
  spec:
    storageClassName: ${STORAGE_CLASS_NAME}
    accessModes:
    - ReadWriteOnce
    resources:
      requests:
        storage: ${GERRIT_DB_CAPACITY}
{% endif %}
- apiVersion: v1
  kind: Service
  metadata:
    labels:
      app: gerrit-db
    name: gerrit-db
  spec:
    ports:
    - name: db
      port: 5432
    selector:
      app: gerrit-db
- apiVersion: v1
  kind: Route
  metadata:
    annotations:
      description: Route for Gerrit's http service.
    name: gerrit
    labels:
      app: gerrit
  spec:
    to:
      kind: Service
      name: gerrit
    port:
      targetPort: ui
- apiVersion: v1
  kind: ConfigMap
  metadata:
    name: gerrit
  data:
    config: |
      Host ${GITLAB_GROUP_HOST}
          User git
          IdentityFile /var/gerrit/review_site/etc/replication_rsa_key
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
    replication.config: |
      [gerrit]
        defaultForceUpdate = true
      [remote "${GITLAB_PROJECT_NAME}"]
        url = ${GITLAB_GROUP_HOST}:${GITLAB_GROUP_PATH}/${GITLAB_PROJECT_NAME}.git
        fetch = +refs/*:refs/*
        push = +refs/heads/*:refs/heads/*
        projects = ${GITLAB_PROJECT_NAME}
        replicatePermissions = false
    sshPort: ${GERRIT_SSH_PORT}
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    labels:
      app: gerrit
    name: gerrit-db
  spec:
    replicas: 1
    selector:
      app: gerrit-db
    strategy:
      activeDeadlineSeconds: 21600
      recreateParams:
        timeoutSeconds: 600
      resources: {}
      type: Recreate
    template:
      metadata:
        labels:
          app: gerrit-db
      spec:
        containers:
        - name: gerrit-db
          env:
          - name: POSTGRES_DB
            valueFrom:
              secretKeyRef:
                name: gerrit-db
                key: database-name
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: gerrit-db
                key: database-user
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: gerrit-db
                key: database-password
          - name: PGDATA
            value: /var/lib/postgresql/data/pgdata
          - name: POD_IP
            valueFrom: { fieldRef: { fieldPath: status.podIP } }
          image: postgres:9.6
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              memory: 1Gi
          ports:
            - containerPort: 5432
              protocol: TCP
          livenessProbe:
            exec:
              command:
              - sh
              - -c
              - exec pg_isready --host $POD_IP
            initialDelaySeconds: 60
            timeoutSeconds: 5
            failureThreshold: 6
          readinessProbe:
            exec:
              command:
              - sh
              - -c
              - exec pg_isready --host $POD_IP
            initialDelaySeconds: 30
            timeoutSeconds: 3
            periodSeconds: 5
          volumeMounts:
            - mountPath: /var/lib/postgresql/data
              name: gerrit-db
        serviceAccount: gerrit
        volumes:
        - name: gerrit-db
{% if mr_deploy == 'false' %}
          persistentVolumeClaim:
            claimName: gerrit-db
{% else %}
          emptyDir: {}
{% endif %}
- apiVersion: apps.openshift.io/v1
  kind: DeploymentConfig
  metadata:
    labels:
      app: gerrit
    name: gerrit
  spec:
    replicas: 1
    selector:
      app: gerrit
    strategy:
      activeDeadlineSeconds: 21600
      recreateParams:
        timeoutSeconds: 600
      resources: {}
      type: Recreate
    template:
      metadata:
        labels:
          app: gerrit
      spec:
        initContainers:
        - name: init-gerrit-db
          image: busybox
          command: ["sh", "-c", "while ! nc -w 1 gerrit-db 5432 </dev/null; do echo waiting for gerrit-db; sleep 10; done;"]
        containers:
        - name: gerrit
          env:
          - name: WEBURL
            value: ${GERRIT_WEB_URL}
          - name: LISTEN_ADDR
            value: '*:${GERRIT_SSH_PORT}'
          - name: AUTH_TYPE
            value: {{ tools.gerrit.auth_type }}
          - name: OAUTH_GITLAB_ROOT_URL
            value: https://git.epam.com/
          - name: OAUTH_GITLAB_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: gitlab-oauth
                key: secret
          - name: OAUTH_GITLAB_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: gitlab-oauth
                key: id
          - name: DATABASE_TYPE
            value: postgresql
          - name: DB_PORT_5432_TCP_ADDR
            value: gerrit-db
          - name: DB_PORT_5432_TCP_PORT
            value: "5432"
          - name: DB_ENV_POSTGRES_DB
            valueFrom:
              secretKeyRef:
                name: ${GERRIT_DB_SECRET}
                key: database-name
          - name: DB_ENV_POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: ${GERRIT_DB_SECRET}
                key: database-user
          - name: DB_ENV_POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: ${GERRIT_DB_SECRET}
                key: database-password
          - name: GERRIT_INIT_ARGS
            value: --install-plugin=commit-message-length-validator --install-plugin=download-commands --install-plugin=hooks --install-plugin=reviewnotes --install-plugin=singleusergroup --install-plugin=replication
          image: openfrontier/gerrit:${GERRIT_VERSION}
          imagePullPolicy: IfNotPresent
          name: gerrit
          securityContext:
            fsGroup: 1000
          ports:
          - name: ui
            containerPort: 8080
          - name: ssh
            containerPort: ${GERRIT_SSH_PORT}
          readinessProbe:
            initialDelaySeconds: 30
            successThreshold: 1
            timeoutSeconds: 3
            periodSeconds: 10
            tcpSocket:
              port: 8080
          resources:
            requests:
              memory: 1Gi
          volumeMounts:
            - mountPath: /var/gerrit/review_site
              name: gerrit-data
            - mountPath: /var/gerrit/.ssh
              name: ssh-config
        serviceAccount: gerrit
        volumes:
          - name: gerrit-data
{% if mr_deploy == 'false' %}
            persistentVolumeClaim:
              claimName: gerrit-data
{% else %}
            emptyDir: {}
{% endif %}
          - configMap:
              defaultMode: 420
              items:
                - key: config
                  path: config
              name: gerrit
            name: ssh-config
parameters:
- displayName: Gerrit version
  value: "2.14.1"
  name: GERRIT_VERSION
- displayName: Gerrit DB secret
  value: "gerrit-db"
  name: GERRIT_DB_SECRET
- description: Volume space available for Gerrit
  displayName: Gerrit Volume Capacity
  name: GERRIT_DATA_CAPACITY
  value: 2Gi
- description: Volume space available for Gerrit DB
  displayName: Gerrit database Volume Capacity
  name: GERRIT_DB_CAPACITY
  value: 2Gi
- description: Gerrit WEB URL is needed for authentication purposes
  displayName: Gerrit WEB URL
  name: GERRIT_WEB_URL
  value: "http://gerrit-test-mb.demo.edp.projects.epam.com"
- displayName: GitLab host
  value: "git.epam.com"
  name: GITLAB_GROUP_HOST
- displayName: GitLab group path
  value: "epmd-edp/temp"
  name: GITLAB_GROUP_PATH
- displayName: GitLab project name
  name: GITLAB_PROJECT_NAME
- displayName: Gerrit ssh port
  value: "29418"
  name: GERRIT_SSH_PORT
  required: true
- displayName: Gerrit storage class name
  description: Storage class name to consume by Gerrit
  name: STORAGE_CLASS_NAME
