# Copyright 2018 EPAM Systems.

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

# See the License for the specific language governing permissions and
# limitations under the License.

---
- set_fact:
   sonar_reboot: false
   enable_oidc: "{{ tools.sonar.enable_oidc }}"

- include_tasks: sonar-api/install-plugins.yml
  with_items:
    - authoidc
    - checkstyle
    - findbugs
    - pmd

- include_tasks: sonar-api/restart.yml
  when: sonar_reboot|bool == true

- include_tasks: sonar-api/upload-profile.yml
  with_items:
    - { name: 'EDP way', filename: "quality-profile.xml"}

- include_tasks: sonar-api/set-default-profile.yml
  with_items:
    - { name: 'EDP way', language: 'java' }

- include_tasks: sonar-api/activate-profile-rules.yml
  with_items:
    - { profile_id: '{{ profile_id }}', languages: 'java' }

- include_tasks: sonar-api/deactivate-profile-rules.yml
  with_items: "{{ profile_id }}"

- include_tasks: sonar-api/create-user.yml
  with_items:
    - { login: 'jenkins', name: 'Jenkins', password: 'jenkins' }

- include_tasks: sonar-api/create-group.yml
  with_items:
    - non-interactive-users

- include_tasks: sonar-api/add-user-to-group.yml
  with_items:
    - { login: 'jenkins', group: 'non-interactive-users' }

- include_tasks: sonar-api/add-permission-to-user.yml
  with_items:
    - { login: 'jenkins', permission: 'scan' }

- include_tasks: sonar-api/generate_token.yml
  with_items:
    - { login: 'jenkins', name: 'Jenkins' }

- include_tasks: sonar-api/add-webhook.yml
  with_items:
    - { name: 'jenkins', url: 'http://jenkins:8080/sonarqube-webhook/' }

- include_tasks: sonar-api/set-general-setting.yml
  vars:
    value_type: values
  with_items:
    - { key: 'sonar.typescript.lcov.reportPaths', value: 'coverage/lcov.info' }

- include_tasks: sonar-api/set-keycloak-integration.yml
  when: enable_oidc | bool == true
