# Copyright 2018 EPAM Systems.

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

# See the License for the specific language governing permissions and
# limitations under the License.

---
- name: "Get project-settings configmap"
  shell: "{{ ocadm }} -n {{ project_cicd }} export cm project-settings -o json"
  register: project_settings_configmap

- set_fact:
    project_settings: "{{ project_settings_configmap.stdout | from_json }}"

- name: "Retrive app settings"
  set_fact:
    new_app_settings: "{{ new_app_settings | default([]) | combine(item) }}"
  with_items: "{{ project_settings.data[\"app.settings.json\"] }}"
  register: temp_new_app_settings

- set_fact:
    new_app_settings: "{{ temp_new_app_settings | json_query(json_template) }}"
  vars:
    json_template: "results[?item.name!=`{{ vcs_project_name }}`].item"

- set_fact:
    project_settings: "{{ project_settings | combine({'data':{'app.settings.json':new_app_settings | to_nice_json }}, recursive=True) }}"

- debug:
    msg: "new project-settings: {{ project_settings }}"

- local_action: copy content="{{ project_settings }}" dest="/tmp/project_settings.yaml"

- name: "Update configmap"
  shell: "{{ ocadm }} -n {{ project_cicd }} replace cm project-settings -f /tmp/project_settings.yaml"

- name: 'Delete Job'
  shell: "{{ ocadm }} -n {{ project_cicd }} delete jobs {{ job_name }}"
