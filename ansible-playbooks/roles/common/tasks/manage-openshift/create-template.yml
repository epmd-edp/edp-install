# Copyright 2019 EPAM Systems.

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

# See the License for the specific language governing permissions and
# limitations under the License.

---
- name: "Check template for this particular application name exists"
  stat:
    path: "{{ role_path }}/templates/{{ item_map.name | lower }}.j2"
  register: template_file
  when: item_map is defined

- set_fact:
    source_template: "{{ item_map.name + '.j2' if template_file.stat.exists else item_map.language | lower + '/' + item_map.framework | regex_replace('\\(.*', '') | lower + '.j2' }}"
  when: item_map is defined and (template_file.stat.exists or ( item_map.language is defined and item_map.framework is defined))

- block:
  - name: "Copying template for application"
    template:
      src: "{{ source_template }}"
      dest: "{{ item_map.name }}.yaml"
      force: no

  - name: "Create template in Openshift"
    shell: "{{ ocadm }} create -f {{ item_map.name }}.yaml -n {{ project_cicd }} "
    register: result
    ignore_errors: true
  when: source_template is defined