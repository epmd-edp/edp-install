---
- name: "Get Openshift docker registry url"
  shell: "{{ ocadm }} -n default get route docker-registry -o jsonpath='{.spec.host}'"
  register: docker_registry_url

- name: "Get wildcard from user-settings cm"
  shell: |
   {{ ocadm }} -n {{ project_cicd }} get cm user-settings -o=jsonpath='{ .data.dns_wildcard }'
  register: dns_wildcard

- name: "Get projects suffix from user-settings config map"
  command: |
   {{ ocadm }} -n {{ project_cicd }} get cm user-settings -o=jsonpath='{ .data.projects_suffix }'
  register: projects_suffix

- name: "Get gerrit ssh port from service"
  command: "{{ ocadm }} -n {{ project_cicd }} get svc gerrit -o=jsonpath='{.spec.ports[?(@.name==\"ssh\")].nodePort}'"
  register: gerrit_ssh_port

- name: "Get GitLab URL"
  shell: |
    {{ ocadm }} -n {{ project_cicd }} get cm user-settings -o=jsonpath='{ .data.gitlab_group_name_url }'
  register: git_repo_url_default

- name: "Set variables"
  set_fact:
    dns_wildcard: "{{ dns_wildcard.stdout }}"
    docker_registry_url: "{{ docker_registry_url.stdout }}"
    edp_gerrit_project: "{{ (projects_suffix != '') | ternary('edp-' + projects_suffix.stdout, 'edp')}}"
    gerrit_ssh_port: "{{ gerrit_ssh_port.stdout }}"
    gitlab_host: "{{ git_repo_url_default.stdout }}"

- include_tasks: roles/common/tasks/manage-ssh/generate-ssh-config.yml

- name: "Pull EDP repo from gerrit"
  shell: >
   git clone ssh://project-creator@gerrit.{{ project_cicd }}:{{ gerrit_ssh_port }}/{{ edp_gerrit_project }} &&
   scp -p -P {{ gerrit_ssh_port }} project-creator@gerrit.{{ project_cicd }}:hooks/commit-msg {{ edp_gerrit_project }}/.git/hooks/
  args:
    chdir: "{{ templates_dir }}"

- name: "Create directories"
  file:
    path: "{{ templates_dir }}/{{ item }}"
    state: directory
  with_items:
    - "{{ edp_gerrit_project }}/deploy-templates"
    - "business-apps"

- name: "Copying templates for new business application"
  template:
    src: "business-applications/{{ language | lower }}/{{ item.src }}.j2"
    dest: "{{ templates_dir }}/{{ item.dst }}"
  with_items:
    - { src: "{{ framework | lower }}", dst: "{{ edp_gerrit_project }}/deploy-templates/{{ app_name }}.yaml" }
    - { src: "s2i-{{ framework | lower }}", dst: "business-apps/s2i-{{ app_name }}.yaml" }

- name: "Push templates to gerrit"
  shell: |
   git config user.email "{{ gitlab_autouser_email }}"
   git config user.name "{{ gitlab_autouser_name }}"
   git add . && git commit -m "Add template for {{ app_name }}"
   git push origin master
  args:
    chdir: "{{ templates_dir }}/{{ edp_gerrit_project }}"

- name: "Create s2i image stream for new business-app"
  command: |
    {{ ocadm }} -n {{ project_cicd }} apply -f {{ templates_dir }}/business-apps/s2i-{{ app_name }}.yaml