# Copyright 2018 EPAM Systems.

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

# See the License for the specific language governing permissions and
# limitations under the License.

---
# file: group_vars/all
ansible_connection: ssh
work_dir: "/home/edp"
post_integration_dir: "{{ work_dir }}/post-integration"
secrets_dir: "{{ work_dir }}/secrets"
templates_dir: "{{ work_dir }}/oc-templates"
files_dir: "{{ work_dir }}/files"
edp_name: ""
edp_deploy_project: "{{ lookup('env', 'DEPLOY-PROJECT') }}"
projects_list: [
    "{{ edp_name }}-edp-cicd"
    ]
project_cicd: "{{ edp_name }}-edp-cicd"
full_edp_name: "{{ edp_name }}-edp"
ocadm: "oc --config=/etc/origin/master/admin.kubeconfig"
vcs_integration_enabled: "{{ vcs_integration_enabled | lower | default 'false'}}"
vcs_ssh_port: "{{ vcs_ssh_port | default('7999') if vcs_integration_enabled|bool == true else undefined }}"
vcs_auto_user_secret_name: "{{ 'vcs-autouser-edp-' + edp_name + '-temp' if vcs_integration_enabled|bool == true else undefined }}"
perf_integration_enabled: "{{ perf_integration_enabled | lower | default 'false'}}"
perf_node_id: "{{ perf_node_id if perf_integration_enabled|bool == true else undefined }}"
perf_user_secret_name: "{{ 'perf-user-edp-' + edp_name + '-temp' if perf_integration_enabled|bool == true else undefined }}"
perf_web_url: "{{ perf_url if perf_integration_enabled|bool == true else undefined }}"
ephemeral_data: "{{ (lookup('env', 'EPHEMERAL_DATA') == 'true') | ternary('true', 'false') }}"
dev_deploy: "{{ (lookup('env', 'DEV_DEPLOY') == 'true') | ternary('true', 'false') }}"
default_operators_deploy_project: "{{ edp_name }}-deploy-project"
operators_deploy_project: "{{ default_operators_deploy_project if dev_deploy|bool == true else edp_deploy_project }}"
shared_database: "edp-install-wizard-db"
stages_repo: "{{ lookup('env', 'STAGES_REPO') | default('https://github.com/epmd-edp/edp-library-stages.git',true) }}"
pipelines_repo: "{{ lookup('env', 'PIPELINES_REPO') | default('https://github.com/epmd-edp/edp-library-pipelines.git',true) }}"
stages_version: "{{ lookup('env', 'STAGES_VERSION') }}"
pipelines_version: "{{ lookup('env', 'PIPELINES_VERSION') }}"
default_super_admin: "admin-{{ edp_name }}-edp"
edp_super_admins: "{{ (super_admin_users == '') | ternary(default_super_admin, super_admin_users.split(',')) | lower }}"
edp_admins: "{{ admin_users.split(',') | lower }}"
edp_viewers: "{{ view_users.split(',') | lower }}"
basic_pattern_url: "https://github.com/epmd-edp"
random_password: "{{ lookup('password', '/dev/null length=10 chars=ascii_letters') }}"
secrets:
  sonar_admin:
    password: "{{ lookup('password', '/dev/null length=10 chars=ascii_letters') }}"
    default_password: admin
  sonar_perf:
    password: "{{ lookup('password', '/dev/null length=10 chars=ascii_letters') }}"
  nexus_admin:
    password: "{{ lookup('password', '/dev/null length=10 chars=ascii_letters') }}"
    default_password: admin123
  gerrit_admin:
    password: "{{ lookup('password', '/dev/null length=10 chars=ascii_letters') }}"
    email: admin@example.com
  gerrit_perf:
    password: "{{ lookup('password', '/dev/null length=10 chars=ascii_letters') }}"
  jenkins_admin:
    password: "{{ lookup('password', '/dev/null length=10 chars=ascii_letters') }}"
  gerrit_db:
    db_name: gerrit
    db_user: gerrit
    db_password: "{{ lookup('password', '/dev/null length=10 chars=ascii_letters') }}"
  sonar_db:
    db_name: sonar
    db_user: sonar
    db_password: "{{ lookup('password', '/dev/null length=10 chars=ascii_letters') }}"
tools:
  jenkins:
    web_url: "https://jenkins-{{ project_cicd }}.{{ dns_wildcard | default('delivery.aws.main.edp.projects.epam.com') }}"
    secret: "jenkins-passwords"
    admin_token: "{{ jenkins_admin_token | default('token') }}"
    fs_type: "{{ jenkins_fs_type | default('pvc') }}"
    host_path_volume: "{{ jenkins_host_path_volume | default('/opt/data/jenkins') }}"
    service_name: "{{ jenkins_service_name | default('jenkins') }}"
    volume_capacity: "{{ jenkins_volume_capacity | default('5Gi') }}"
    maven_cache_volume_capacity: "{{ jenkins_maven_cache_volume_capacity | default('5Gi') }}"
    frontend_image: "{{ jenkins_frontend_image | default('openshift/jenkins-agent-nodejs-8-centos7:v3.10') }}"
    backend_maven_image: "{{ jenkins_backend_maven_image | default('openshift/jenkins-slave-maven-centos7') }}"
    backend_gradle_image: "{{ jenkins_backend_gradle_image | default('epamedp/jenkins-slave-gradle-openshift') }}"
    jenkins_image: "{{ jenkins_image_version | default('docker-registry-default.delivery.aws.main.edp.projects.epam.com/infra/edp-jenkins:latest') }}"
  gerrit:
    secret: "gerrit-passwords"
    db_secret: "gerrit-db"
    version: "{{ gerrit_version | default('2.14.8') }}"
    volume_capacity: "{{ gerrit_volume_capacity | default('5Gi') }}"
    volume_db_capacity: "{{ gerrit_volume_db_capacity | default('2Gi') }}"
    web_url: "https://gerrit-{{ project_cicd }}.{{ dns_wildcard | default('delivery.aws.main.edp.projects.epam.com') }}"
  nexus:
    secret: "nexus-passwords"
    version: "{{ nexus_version | default('3.15.1') }}"
    volume_capacity: "{{ nexus_volume_capacity | default('5Gi') }}"
    repos_defaults:
      blob_store: default # Note : cannot be updated once the repo has been created
      strict_content_validation: true
      version_policy: mixed # release, snapshot or mixed
      layout_policy: strict # strict or permissive
      write_policy: allow # allow_once or allow
    privilege_defaults:
      type: repository-view
      format: maven2
      actions:
        - read
    blobs:
      - name: edp-npm
        path: /nexus-data/blobs/edp-npm
      - name: edp-maven
        path: /nexus-data/blobs/edp-maven
      - name: edp-dotnet
        path: /nexus-data/blobs/edp-dotnet
    repos_to_delete:
      - maven-central
      - maven-public
      - maven-releases
      - maven-snapshots
      - nuget-group
      - nuget-hosted
      - nuget.org-proxy
    repos_npm_proxy:
      - name: edp-npm-proxy
        blob_store: "edp-npm"
        remote_url: https://registry.npmjs.org
    repos_npm_hosted:
      - name: edp-npm-hosted
        blob_store: "edp-npm"
    repos_npm_group:
      - name: edp-npm-group
        blob_store: "edp-npm"
        member_repos:
          - edp-npm-hosted
          - edp-npm-proxy
    repos_maven_proxy:
      - name: edp-maven-proxy
        blob_store: "edp-maven"
        remote_url: https://repo1.maven.org/maven2/
    repos_maven_hosted:
      - name: edp-maven-releases
        blob_store: "edp-maven"
        version_policy: release
      - name: edp-maven-snapshots
        blob_store: "edp-maven"
        version_policy: snapshot
    repos_maven_group:
      - name: edp-maven-group
        blob_store: "edp-maven"
        member_repos:
          - edp-maven-proxy
          - edp-maven-releases
          - edp-maven-snapshots
    repos_dotnet_proxy:
      - name: edp-dotnet-proxy
        blob_store: "edp-dotnet"
        remote_url: https://www.nuget.org/api/v2/
    repos_dotnet_hosted:
      - name: edp-dotnet-hosted
        blob_store: "edp-dotnet"
    repos_dotnet_group:
      - name: edp-dotnet-group
        blob_store: "edp-dotnet"
        member_repos:
          - edp-dotnet-hosted
          - edp-dotnet-proxy
    realms_enabled:
       - name: NuGetApiKey
    nexus_scheduled_tasks:
      - name: compact-blobstore-default
        cron: '0 0 9 * * ?'
        typeId: blobstore.compact
        taskProperties:
          blobstoreName: 'default'
      - name: compact-blobstore-npm
        cron: '0 20 9 * * ?'
        typeId: blobstore.compact
        taskProperties:
          blobstoreName: 'npm'
      - name: purge-unused-components-and-assets
        cron: '0 40 9 * * ?'
        typeId: "repository.purge-unused"
        taskProperties:
          repositoryName: "*"
          lastUsed: "14"
      - name: purge-orphaned-api-keys
        cron: '0 0 10 * * ?'
        typeId: security.purge-api-keys
      - name: purge-unused-maven-snapshot-versions
        cron: '0 20 10 * * ?'
        typeId: repository.maven.purge-unused-snapshots
        taskProperties:
          repositoryName: "*"
          lastUsed: "14"
      - name: remove-maven-indexes
        cron: '0 40 10 * * ?'
        typeId: repository.maven.unpublish-dotindex
        taskProperties:
          repositoryName: "*"
      - name: remove-snapshots-from-maven-repository
        cron: '0 0 11 * * ?'
        typeId: repository.maven.remove-snapshots
        taskProperties:
          repositoryName: "*"
          minimumRetained: "1"
          snapshotRetentionDays: "30"
          gracePeriodInDays: "10"
      - name: rebuild-maven-repository-metadata
        cron: '0 20 11 * * ?'
        typeId: repository.maven.rebuild-metadata
        taskProperties:
          repositoryName: "*"
      - name: rebuild-repository-index
        cron: '0 40 11 * * ?'
        typeId: "repository.rebuild-index"
        taskProperties:
          repositoryName: "*"
    roles:
      - id: nexus-rw
        name: nexus-rw
        description: Jenkins-CI
        privileges:
          - nx-search-read
          - nx-repository-view-*-*-read
          - nx-repository-view-*-*-browse
          - nx-repository-view-*-*-add
          - nx-repository-view-*-*-edit
          - nx-apikey-all
          - nx-script-*-add
          - nx-script-*-delete
          - nx-script-*-run
        roles: []
      - id: keycloak-developer
        name: keycloak-developer
        description: Keycloak developer
        privileges:
          - nx-search-read
          - nx-repository-view-*-*-read
          - nx-repository-view-*-*-browse
        roles: []
    local_users:
      - username: jenkins
        jenkins_id: nexus
        first_name: Jenkins
        last_name: CI
        email: jenkins@edp.com
        password: "{{ jenkins_nexus_password | default(lookup('password', '/dev/null length=10 chars=ascii_letters')) }}"
        roles:
          - nexus-rw
    client_id: "nexus3"
    web_url: "https://nexus-{{ project_cicd }}.{{ dns_wildcard | default('delivery.aws.main.edp.projects.epam.com') }}"
  sonar:
    secret: "sonar-passwords"
    db_secret: "sonar-db"
    version: "{{ sonar_version | default('7.1') }}"
    volume_capacity: "{{ sonar_volume_capacity | default('1Gi') }}"
    volume_db_capacity: "{{ sonar_volume_db_capacity | default('2Gi') }}"
    profiles:
      - { name: "EDP way", filename: 'quality-profile.xml' }
    web_url: "https://sonar-{{ project_cicd }}.{{ dns_wildcard | default('delivery.aws.main.edp.projects.epam.com') }}"
  cockpit:
    version: "{{ cockpit_version | default('docker-registry-default.delivery.aws.main.edp.projects.epam.com/infra/edp-cockpit:snapshot') }}"
    openshift_trust_certificates: "true"
    client_id: "cockpit"
    web_url: "https://edp-cockpit-{{ project_cicd }}.{{ dns_wildcard | default('delivery.aws.main.edp.projects.epam.com') }}"
  admin_console:
    db_secret: "admin-console-db"
    version: "{{ admin_console_version | default('docker-registry-default.delivery.aws.main.edp.projects.epam.com/infra/edp-admin-console:snapshot') }}"
    web_url: "https://edp-admin-console-{{ project_cicd }}.{{ dns_wildcard | default('delivery.aws.main.edp.projects.epam.com') }}"
  keycloak:
    realm_name: "{{ full_edp_name }}"
    web_url: "https://keycloak-security.{{ dns_wildcard | default('delivery.aws.main.edp.projects.epam.com') }}"
