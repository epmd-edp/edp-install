---
- set_fact:
    gerrit_project: "{{ (projects_suffix != '') | ternary('edp-' + projects_suffix, 'edp')}}"

- name: "Generate templates"
  vars:
    env_name: "{{ item.name }}"
    env_triggers: "{{ item.triggers }}"
  template:
    src: build-config.j2
    dest: "{{ templates_dir }}/{{ item.name }}-bc.json"
  with_items: "{{ env_map | list }}"

- name: "Create Pipelines in Openshift"
  command: |
   {{ ocadm }} -n {{ project_cicd }} apply -f {{ templates_dir }}/{{ item.name }}-bc.json
  with_items: "{{ env_map | list }}"

- name: "Generate deletion pipeline template"
  template:
    src: deletion-pipeline.j2
    dest: "{{ templates_dir }}/deletion-pipeline.json"

- name: "Create deletion pipeline in Openshift"
  command: |
   {{ ocadm }} -n {{ project_cicd }} apply -f {{ templates_dir }}/deletion-pipeline.json